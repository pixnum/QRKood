<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>QRKood - QR Code Generator</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    :root {
      --bg: #e0e5ec;
      --fg: #1a1a1a;
      --primary: #6750a4;
      --primary-light: #957dad;
      --secondary: #8a94a6;
      --input-bg: #f0f0f3;
      --input-fg: #333;
      --card-shadow-light: 15px 15px 30px #c3c7d8,
                          -15px -15px 30px #ffffff;
      --card-shadow-dark: inset 6px 6px 8px #1c1c24,
                         inset -6px -6px 8px #2e2e39;
      --transition-speed: 0.35s;
    }
    [data-theme="dark"] {
      --bg: #121318;
      --fg: #e5e5e5;
      --primary: #8a63d2;
      --primary-light: #b398ec;
      --secondary: #7f7f9d;
      --input-bg: #1c1c24;
      --input-fg: #ccc;
      --card-shadow-light: none;
      --card-shadow-dark: 6px 6px 12px #0a0a0f,
                         -6px -6px 12px #262631;
    }
    * {
      box-sizing: border-box;
      outline-offset: 2px;
    }
    body {
      margin: 0; padding: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: var(--fg);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      user-select: none;
      transition: background var(--transition-speed), color var(--transition-speed);
    }
    header {
      position: sticky;
      top: 0;
      width: 100%;
      background: var(--bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 1rem 1.5rem;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    header h1 {
      font-weight: 700;
      font-size: 1.5rem;
      letter-spacing: 2px;
      color: var(--primary);
      user-select: text;
      margin: 0;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    .switch input { display:none; }
    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: linear-gradient(145deg, #b7b9bf, #f0f0f3);
      border-radius: 28px;
      box-shadow: var(--card-shadow-light);
      transition: 0.4s;
    }
    [data-theme="dark"] .slider {
      background: linear-gradient(145deg, #15151c, #1f1f28);
      box-shadow: var(--card-shadow-dark);
    }
    .slider:before {
      content: "";
      position: absolute;
      height: 22px;
      width: 22px;
      left: 3px;
      top: 3px;
      background: white;
      border-radius: 50%;
      box-shadow:
        0 2px 4px rgba(0,0,0,0.2),
        inset 0 2px 2px rgba(255,255,255,0.7);
      transition: 0.4s;
    }
    input:checked + .slider {
      background: var(--primary);
      box-shadow:
        0 0 15px var(--primary-light),
        inset 0 0 15px var(--primary-light);
    }
    input:checked + .slider:before {
      transform: translateX(22px);
      background: white;
      box-shadow:
        0 2px 6px var(--primary-light);
    }
    main {
      max-width: 720px;
      width: 90vw;
      margin-top: 2rem;
      padding: 2rem 2.5rem;
      background: var(--bg);
      border-radius: 32px;
      box-shadow: var(--card-shadow-light);
      transition: box-shadow var(--transition-speed);
      user-select: text;
    }
    [data-theme="dark"] main {
      box-shadow: var(--card-shadow-dark);
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.4rem;
      color: var(--secondary);
      user-select: text;
    }
    select, input[type="text"], input[type="url"], input[type="email"], input[type="tel"],
    input[type="password"], textarea, input[type="color"], input[type="number"], input[type="datetime-local"], input[type="file"] {
      width: 100%;
      padding: 0.8rem 1rem;
      font-size: 1rem;
      border-radius: 18px;
      border: none;
      background: var(--input-bg);
      color: var(--input-fg);
      box-shadow:
        7px 7px 12px #bec4d4,
        -7px -7px 12px #ffffff;
      transition: box-shadow var(--transition-speed);
      resize: vertical;
      user-select: text;
      font-family: inherit;
    }
    [data-theme="dark"] select, [data-theme="dark"] input[type="text"], [data-theme="dark"] input[type="url"], [data-theme="dark"] input[type="email"], 
    [data-theme="dark"] input[type="tel"], [data-theme="dark"] input[type="password"], [data-theme="dark"] textarea, [data-theme="dark"] input[type="color"], 
    [data-theme="dark"] input[type="number"], [data-theme="dark"] input[type="datetime-local"], [data-theme="dark"] input[type="file"] {
      box-shadow:
        inset 3px 3px 6px #131316,
        inset -3px -3px 6px #1c1c25;
      background: var(--input-bg);
      color: var(--input-fg);
    }
    select:focus, input:focus, textarea:focus {
      outline: none;
      box-shadow:
        0 0 0 3px var(--primary-light);
    }
    textarea {
      min-height: 80px;
    }
    .flex-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    .flex-row > * {
      flex: 1 1 150px;
      min-width: 140px;
    }
    button {
      padding: 1rem 1.8rem;
      margin-top: 1.2rem;
      border-radius: 28px;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--fg);
      background: var(--bg);
      box-shadow:
        7px 7px 15px #bec4d4,
        -7px -7px 15px #ffffff;
      border: none;
      cursor: pointer;
      user-select: none;
      transition:
        background-color 0.3s,
        box-shadow 0.3s,
        color 0.3s;
      width: 100%;
      max-width: 240px;
    }
    button:hover, button:focus {
      box-shadow:
        inset 7px 7px 15px #bec4d4,
        inset -7px -7px 15px #ffffff;
      color: var(--primary);
      background-color: var(--bg);
      outline: none;
    }
    [data-theme="dark"] button {
      box-shadow:
        7px 7px 15px #121316,
        -7px -7px 15px #2c2c35;
      color: var(--fg);
    }
    [data-theme="dark"] button:hover, [data-theme="dark"] button:focus {
      box-shadow:
        inset 7px 7px 15px #121316,
        inset -7px -7px 15px #2c2c35;
      color: var(--primary-light);
      background-color: var(--bg);
    }
    #qrcode {
      margin: 2rem auto;
      position: relative;
      width: fit-content;
      max-width: 100%;
      background: var(--input-bg);
      padding: 1.5rem;
      border-radius: 32px;
      box-shadow:
        8px 8px 16px #bec4d4,
        -8px -8px 16px #ffffff;
      user-select: none;
      transition: box-shadow var(--transition-speed);
    }
    [data-theme="dark"] #qrcode {
      box-shadow:
        8px 8px 20px #121316,
        -8px -8px 20px #2c2c35;
      background: var(--input-bg);
    }
    #qrcode canvas, #qrcode svg {
      display: block;
      max-width: 100%;
      height: auto;
      border-radius: 16px;
      user-select: none;
    }
    #logo-preview {
      position: absolute;
      top: 50%;
      left: 50%;
      max-width: 30%;
      max-height: 30%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      opacity: 0.9;
      border-radius: 50%;
      box-shadow:
        0 0 12px 3px var(--primary-light);
      user-select: none;
    }
    footer {
      font-weight: 600;
      font-size: 0.85rem;
      margin: 2rem 0 1rem 0;
      color: var(--secondary);
      user-select: text;
    }
    #video {
      border-radius: 20px;
      margin-top: 1.2rem;
      box-shadow:
        8px 8px 20px #bec4d4,
        -8px -8px 20px #ffffff;
      max-width: 100%;
      user-select: none;
    }
    [data-theme="dark"] #video {
      box-shadow:
        8px 8px 20px #121316,
        -8px -8px 20px #2c2c35;
    }
    #scanResult {
      margin-top: 1rem;
      font-weight: 700;
      color: var(--primary);
      word-break: break-word;
      user-select: text;
    }
    #history-list {
      max-height: 160px;
      overflow-y: auto;
      border-radius: 20px;
      background: var(--input-bg);
      box-shadow:
        inset 6px 6px 12px #ffffff,
        inset -6px -6px 12px #bec4d4;
      padding: 0.5rem;
      margin-top: 1rem;
      user-select: none;
    }
    [data-theme="dark"] #history-list {
      box-shadow:
        inset 6px 6px 12px #121316,
        inset -6px -6px 12px #2c2c35;
      background: var(--input-bg);
    }
    #history-list > div {
      padding: 0.35rem 0.8rem;
      border-radius: 18px;
      font-weight: 600;
      color: var(--secondary);
      cursor: pointer;
      transition: background-color 0.25s, color 0.25s;
      user-select: text;
    }
    #history-list > div:hover, #history-list > div:focus {
      background: var(--primary);
      color: white;
      outline: none;
    }
    @media (max-width: 600px) {
      main {
        padding: 1.5rem 1.5rem 2rem;
      }
      .flex-row {
        flex-direction: column;
      }
      .flex-row > * {
        min-width: auto;
      }
      button {
        max-width: 100%;
      }
      header h1 {
        font-size: 1.25rem;
      }
    }
  </style>
</head>
<body data-theme="light">

  <header>
    <h1>QR Code Generator</h1>
    <label class="switch" title="Toggle Dark Mode">
      <input type="checkbox" id="toggleTheme" aria-label="Toggle Dark Mode" />
      <span class="slider"></span>
    </label>
  </header>

  <main>

    <label for="dataType">Select Data Type</label>
    <select id="dataType" aria-label="Select QR code data type">
      <option value="url">URL</option>
      <option value="text">Plain Text</option>
      <option value="email">Email</option>
      <option value="phone">Phone Number</option>
      <option value="sms">SMS</option>
      <option value="wifi">Wi-Fi</option>
      <option value="vcard">vCard</option>
      <option value="geo">Geo Location</option>
      <option value="calendar">Calendar Event</option>
    </select>

    <div id="inputFields" style="width: 100%; margin-top:0.75rem;"></div>

    <div class="flex-row" style="margin-top: 1.5rem;">

      <div>
        <label for="size">Size (px)</label>
        <input type="number" id="size" min="100" max="1000" value="300" aria-label="QR code size in pixels" />
      </div>

      <div>
        <label for="ecLevel">Error Correction Level</label>
        <select id="ecLevel" aria-label="Error correction level">
          <option value="L">Low (7%)</option>
          <option value="M" selected>Medium (15%)</option>
          <option value="Q">Quartile (25%)</option>
          <option value="H">High (30%)</option>
        </select>
      </div>

      <div>
        <label for="fgColor">Foreground Color</label>
        <input type="color" id="fgColor" value="#000000" aria-label="Foreground color" />
      </div>

      <div>
        <label for="bgColor">Background Color</label>
        <input type="color" id="bgColor" value="#ffffff" aria-label="Background color" />
      </div>
    </div>

    <label for="logoFile" style="margin-top:1.5rem;">Add Logo/Image Overlay (optional)</label>
    <input type="file" id="logoFile" accept="image/*" aria-label="Upload logo or image overlay" />

    <label for="password" style="margin-top:1.5rem;">Password Protect QR Data (optional)</label>
    <input type="password" id="password" placeholder="Enter password to encrypt content" autocomplete="new-password" aria-label="Password for encryption" />

    <button id="generateBtn" aria-label="Generate QR Code">Generate QR Code</button>

    <div id="qrcode" aria-label="Generated QR code" role="img"></div>

    <div class="flex-row" style="gap: 0.75rem; margin-bottom: 1.5rem;">
      <button id="downloadPNG" aria-label="Download QR code as PNG">Download PNG</button>
      <button id="downloadJPEG" aria-label="Download QR code as JPEG">Download JPEG</button>
      <button id="downloadSVG" aria-label="Download QR code as SVG">Download SVG</button>
    </div>

    <button id="scanBtn" aria-label="Scan QR code with device camera">Scan QR Code with Camera</button>
    <video id="video" style="display:none;" autoplay playsinline></video>
    <p id="scanResult" aria-live="polite"></p>

    <label for="bulkUpload" style="margin-top:1.5rem;">Bulk Generate from CSV (dataType,data)</label>
    <input type="file" id="bulkUpload" accept=".csv" aria-label="Upload CSV for bulk QR generation" />
    <div id="bulkResults"></div>

    <h3 style="margin-top:1.5rem;">History (click to reload)</h3>
    <div id="history-list" aria-label="History of generated QR codes"></div>

  </main>

  <footer>© Manik Roy 2025</footer>

  <!-- QRious Library for QR generation -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <!-- CryptoJS AES for simple encryption -->
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const toggleTheme = document.getElementById('toggleTheme');
      const body = document.body;
      const dataType = document.getElementById("dataType");
      const inputFields = document.getElementById("inputFields");
      const generateBtn = document.getElementById("generateBtn");
      const qrcodeContainer = document.getElementById("qrcode");
      const sizeInput = document.getElementById("size");
      const ecLevelSelect = document.getElementById("ecLevel");
      const fgColorInput = document.getElementById("fgColor");
      const bgColorInput = document.getElementById("bgColor");
      const logoFileInput = document.getElementById("logoFile");
      const passwordInput = document.getElementById("password");
      const downloadPNGBtn = document.getElementById("downloadPNG");
      const downloadJPEGBtn = document.getElementById("downloadJPEG");
      const downloadSVGBtn = document.getElementById("downloadSVG");
      const scanBtn = document.getElementById("scanBtn");
      const video = document.getElementById("video");
      const scanResult = document.getElementById("scanResult");
      const bulkUpload = document.getElementById("bulkUpload");
      const bulkResults = document.getElementById("bulkResults");
      const historyList = document.getElementById("history-list");

      let qr; // QRious instance
      let currentLogoImg = null;

      // Initialize theme toggle based on system preference
      if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
        toggleTheme.checked = true;
        body.setAttribute('data-theme','dark');
      }
      toggleTheme.addEventListener('change', () => {
        if(toggleTheme.checked){
          body.setAttribute('data-theme','dark');
        } else {
          body.setAttribute('data-theme','light');
        }
      });

      // Render dynamic inputs based on data type
      function renderInputs(type){
        switch(type){
          case "url":
            inputFields.innerHTML = `
              <label for="urlInput">URL</label>
              <input type="url" id="urlInput" placeholder="https://example.com" />`;
            break;
          case "text":
            inputFields.innerHTML = `
              <label for="textInput">Text</label>
              <textarea id="textInput" rows="4" placeholder="Enter text here"></textarea>`;
            break;
          case "email":
            inputFields.innerHTML = `
              <label for="emailInput">Email</label>
              <input type="email" id="emailInput" placeholder="user@example.com" />`;
            break;
          case "phone":
            inputFields.innerHTML = `
              <label for="phoneInput">Phone Number</label>
              <input type="tel" id="phoneInput" placeholder="+1234567890" />`;
            break;
          case "sms":
            inputFields.innerHTML = `
              <label for="smsPhone">Phone Number</label>
              <input type="tel" id="smsPhone" placeholder="+1234567890" />
              <label for="smsMsg">Message</label>
              <textarea id="smsMsg" rows="2" placeholder="Your SMS message"></textarea>`;
            break;
          case "wifi":
            inputFields.innerHTML = `
              <label for="wifiSSID">SSID</label>
              <input type="text" id="wifiSSID" placeholder="Network Name" />
              <label for="wifiType">Encryption</label>
              <select id="wifiType">
                <option value="WPA">WPA/WPA2</option>
                <option value="WEP">WEP</option>
                <option value="nopass">None</option>
              </select>
              <label for="wifiPassword">Password</label>
              <input type="password" id="wifiPassword" placeholder="Password" />`;
            break;
          case "vcard":
            inputFields.innerHTML = `
              <label for="vcardName">Full Name</label>
              <input type="text" id="vcardName" placeholder="John Doe" />
              <label for="vcardOrg">Organization</label>
              <input type="text" id="vcardOrg" placeholder="Company Inc." />
              <label for="vcardTitle">Title</label>
              <input type="text" id="vcardTitle" placeholder="Job Title" />
              <label for="vcardEmail">Email</label>
              <input type="email" id="vcardEmail" placeholder="email@example.com" />
              <label for="vcardPhone">Phone</label>
              <input type="tel" id="vcardPhone" placeholder="+1234567890" />`;
            break;
          case "geo":
            inputFields.innerHTML = `
              <label for="geoLat">Latitude</label>
              <input type="number" id="geoLat" placeholder="37.4220" step="any" />
              <label for="geoLng">Longitude</label>
              <input type="number" id="geoLng" placeholder="-122.0841" step="any" />`;
            break;
          case "calendar":
            inputFields.innerHTML = `
              <label for="calSummary">Event Summary</label>
              <input type="text" id="calSummary" placeholder="Meeting with Team" />
              <label for="calStart">Start Date & Time</label>
              <input type="datetime-local" id="calStart" />
              <label for="calEnd">End Date & Time</label>
              <input type="datetime-local" id="calEnd" />
              <label for="calLocation">Location</label>
              <input type="text" id="calLocation" placeholder="Meeting Room" />`;
            break;
          default:
            inputFields.innerHTML = `
              <label for="textInput">Text</label>
              <textarea id="textInput" rows="4" placeholder="Enter text here"></textarea>`;
        }
      }

      renderInputs(dataType.value);

      dataType.addEventListener('change', () => {
        renderInputs(dataType.value);
        clearQRCode();
      });

      // Utility: Encrypt text with password or return plain text if no password
      function encryptText(text, password) {
        if(password && password.trim() !== '') {
          try {
            return CryptoJS.AES.encrypt(text, password).toString();
          } catch(e) {
            alert('Encryption failed: ' + e.message);
            return text;
          }
        }
        return text;
      }

      // Compose data string for QR code based on inputs & dataType
      function getDataForQRCode() {
        const type = dataType.value;
        let data = "";
        switch(type){
          case "url":
            const url = document.getElementById("urlInput").value.trim();
            if(!url) throw 'URL is required';
            data = url;
            break;
          case "text":
            const text = document.getElementById("textInput").value.trim();
            if(!text) throw 'Text is required';
            data = text;
            break;
          case "email":
            const email = document.getElementById("emailInput").value.trim();
            if(!email) throw 'Email is required';
            data = `mailto:${email}`;
            break;
          case "phone":
            const phone = document.getElementById("phoneInput").value.trim();
            if(!phone) throw 'Phone number is required';
            data = `tel:${phone}`;
            break;
          case "sms":
            const smsPhone = document.getElementById("smsPhone").value.trim();
            const smsMsg = document.getElementById("smsMsg").value.trim();
            if(!smsPhone) throw 'SMS phone number is required';
            data = `SMSTO:${smsPhone}:${smsMsg}`;
            break;
          case "wifi":
            const ssid = document.getElementById("wifiSSID").value.trim();
            const typeEnc = document.getElementById("wifiType").value;
            const password = document.getElementById("wifiPassword").value;
            if(!ssid) throw 'Wi-Fi SSID is required';
            if(typeEnc === 'nopass') {
              data = `WIFI:T:nopass;S:${ssid};;`;
            } else {
              data = `WIFI:T:${typeEnc};S:${ssid};P:${password};;`;
            }
            break;
          case "vcard":
            const name = document.getElementById("vcardName").value.trim();
            const org = document.getElementById("vcardOrg").value.trim();
            const title = document.getElementById("vcardTitle").value.trim();
            const vEmail = document.getElementById("vcardEmail").value.trim();
            const vPhone = document.getElementById("vcardPhone").value.trim();
            if(!name) throw 'vCard name is required';
            data = `BEGIN:VCARD
VERSION:3.0
N:${name}
ORG:${org}
TITLE:${title}
EMAIL:${vEmail}
TEL:${vPhone}
END:VCARD`;
            break;
          case "geo":
            const lat = document.getElementById("geoLat").value.trim();
            const lng = document.getElementById("geoLng").value.trim();
            if(!lat || !lng) throw 'Latitude and Longitude are required';
            data = `geo:${lat},${lng}`;
            break;
          case "calendar":
            const summary = document.getElementById("calSummary").value.trim();
            const start = document.getElementById("calStart").value;
            const end = document.getElementById("calEnd").value;
            const location = document.getElementById("calLocation").value.trim();
            if(!summary || !start || !end) throw 'Event summary, start and end times are required';
            // Format to iCalendar
            function formatDateTime(s){
              return s.replace(/[-:]/g,"").replace(/\..+/, "") + "Z";
            }
            data = `BEGIN:VEVENT
SUMMARY:${summary}
DTSTART:${formatDateTime(start)}
DTEND:${formatDateTime(end)}
LOCATION:${location}
END:VEVENT`;
            break;
          default:
            data = document.getElementById("textInput").value.trim() || "Hello World";
        }
        // Encrypt if password provided
        const pwd = passwordInput.value;
        if(pwd) data = encryptText(data, pwd);
        return data;
      }

      // Clear QR code area
      function clearQRCode(){
        qrcodeContainer.innerHTML = "";
        currentLogoImg = null;
      }

      // Generate QR Code canvas with options and optional logo overlay
      function generateQRCode(){
        try {
          const qrSize = parseInt(sizeInput.value) || 300;
          if(qrSize < 100 || qrSize > 1000) {
            alert("Size must be between 100 and 1000 pixels.");
            return;
          }
          const ecLevel = ecLevelSelect.value || "M";
          const fg = fgColorInput.value || "#000000";
          const bg = bgColorInput.value || "#ffffff";

          const data = getDataForQRCode();

          clearQRCode();

          qr = new QRious({
            value: data,
            size: qrSize,
            level: ecLevel,
            background: bg,
            foreground: fg,
          });

          // Create canvas to display
          const canvas = qr.canvas;
          canvas.setAttribute("aria-label", "QR code image");
          qrcodeContainer.appendChild(canvas);

          // Add logo overlay if available
          if(currentLogoImg){
            const ctx = canvas.getContext('2d');
            const logoSize = qrSize * 0.25;
            const x = (qrSize - logoSize) / 2;
            const y = (qrSize - logoSize) / 2;
            ctx.drawImage(currentLogoImg, x, y, logoSize, logoSize);
          }

          // Save to history
          saveToHistory({data, size: qrSize, ecLevel, fg, bg, timestamp: Date.now()});
        } catch(e) {
          alert("Error generating QR code: " + e);
        }
      }

      // Save generated QR code info to localStorage history (keep max 20)
      function saveToHistory(entry){
        let history = JSON.parse(localStorage.getItem('qrHistory') || '[]');
        history.unshift(entry);
        if(history.length > 20) history.pop();
        localStorage.setItem('qrHistory', JSON.stringify(history));
        renderHistory();
      }

      // Render history list
      function renderHistory(){
        let history = JSON.parse(localStorage.getItem('qrHistory') || '[]');
        historyList.innerHTML = "";
        if(history.length === 0){
          historyList.textContent = "No history yet.";
          return;
        }
        history.forEach((item, idx) => {
          const div = document.createElement('div');
          const date = new Date(item.timestamp);
          div.tabIndex = 0;
          div.title = `Reload QR code generated on ${date.toLocaleString()}`;
          div.textContent = `[${date.toLocaleDateString()} ${date.toLocaleTimeString()}] ${item.data.slice(0, 30)}...`;
          div.addEventListener('click', () => {
            // Load saved data to UI
            try {
              dataType.value = guessDataType(item.data) || "text";
              renderInputs(dataType.value);
              setTimeout(() => {
                fillInputsFromData(dataType.value, item.data);
                sizeInput.value = item.size || 300;
                ecLevelSelect.value = item.ecLevel || "M";
                fgColorInput.value = item.fg || "#000000";
                bgColorInput.value = item.bg || "#ffffff";
                generateQRCode();
              }, 50);
            } catch(e){
              alert("Failed to load history item: "+ e);
            }
          });
          historyList.appendChild(div);
        });
      }

      // Guess data type from data string
      function guessDataType(data) {
        if(data.startsWith("http") || data.startsWith("www")) return "url";
        if(data.startsWith("mailto:")) return "email";
        if(data.startsWith("tel:")) return "phone";
        if(data.startsWith("SMSTO:")) return "sms";
        if(data.startsWith("WIFI:")) return "wifi";
        if(data.startsWith("BEGIN:VCARD")) return "vcard";
        if(data.startsWith("geo:")) return "geo";
        if(data.startsWith("BEGIN:VEVENT")) return "calendar";
        return "text";
      }

      // Fill inputs based on data type and raw data (basic parsing)
      function fillInputsFromData(type, data) {
        switch(type){
          case "url":
            document.getElementById("urlInput").value = data;
            break;
          case "text":
            document.getElementById("textInput").value = data;
            break;
          case "email":
            document.getElementById("emailInput").value = data.replace("mailto:", "");
            break;
          case "phone":
            document.getElementById("phoneInput").value = data.replace("tel:", "");
            break;
          case "sms":
            let smsMatch = data.match(/^SMSTO:(.*?):(.*)$/);
            if(smsMatch) {
              document.getElementById("smsPhone").value = smsMatch[1];
              document.getElementById("smsMsg").value = smsMatch[2];
            }
            break;
          case "wifi":
            // Parsing WIFI string is complex, skip for now
            break;
          case "vcard":
            // Parsing vCard is complex, skip for now
            break;
          case "geo":
            let geoMatch = data.match(/^geo:(.*?),(.*)$/);
            if(geoMatch){
              document.getElementById("geoLat").value = geoMatch[1];
              document.getElementById("geoLng").value = geoMatch[2];
            }
            break;
          case "calendar":
            // Complex iCal parsing, skip for now
            break;
        }
      }

      // Handle logo file upload and load image object for overlay
      logoFileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if(!file) return;
        if(!file.type.startsWith('image/')){
          alert("Please select a valid image file for logo overlay.");
          return;
        }
        const reader = new FileReader();
        reader.onload = function(evt){
          const img = new Image();
          img.onload = () => {
            currentLogoImg = img;
            if(qr) generateQRCode();
          };
          img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      });

      // Generate button click
      generateBtn.addEventListener('click', () => {
        generateQRCode();
      });

      // Download helpers
      function downloadURI(uri, name){
        const link = document.createElement("a");
        link.href = uri;
        link.download = name;
        document.body.appendChild(link);
        link.click();
        link.remove();
      }

      // Download PNG
      downloadPNGBtn.addEventListener('click', () => {
        if(!qr || !qr.canvas){
          alert("Generate a QR code first!");
          return;
        }
        qr.canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          downloadURI(url, "qrcode.png");
          URL.revokeObjectURL(url);
        });
      });

      // Download JPEG
      downloadJPEGBtn.addEventListener('click', () => {
        if(!qr || !qr.canvas){
          alert("Generate a QR code first!");
          return;
        }
        const jpegDataUrl = qr.canvas.toDataURL("image/jpeg", 0.92);
        downloadURI(jpegDataUrl, "qrcode.jpg");
      });

      // Download SVG (limited support - recreate with qrious.svg())
      downloadSVGBtn.addEventListener('click', () => {
        if(!qr) {
          alert("Generate a QR code first!");
          return;
        }
        // QRious doesn't generate SVG directly, workaround:
        const svgData = qr.toDataURL('image/svg+xml');
        downloadURI(svgData, 'qrcode.svg');
      });

      // Scan QR code with camera using jsQR (needs to load script)
      let scanning = false;
      let videoStream = null;
      scanBtn.addEventListener('click', async () => {
        if(scanning){
          stopScan();
          return;
        }
        if(!('mediaDevices' in navigator)) {
          alert("Camera API not supported on this device/browser.");
          return;
        }
        scanResult.textContent = "";
        try {
          videoStream = await navigator.mediaDevices.getUserMedia({video: { facingMode: "environment" }});
          video.srcObject = videoStream;
          video.style.display = "block";
          scanning = true;
          scanBtn.textContent = "Stop Scanning";
          scanFrame();
        } catch(e) {
          alert("Could not access camera: " + e.message);
        }
      });

      function stopScan(){
        scanning = false;
        scanBtn.textContent = "Scan QR Code with Camera";
        video.style.display = "none";
        scanResult.textContent = "";
        if(videoStream){
          videoStream.getTracks().forEach(track => track.stop());
          videoStream = null;
        }
      }

      // Load jsQR dynamically to avoid bloating
      let jsQRScriptLoaded = false;
      function loadJsQRScript() {
        return new Promise((resolve, reject) => {
          if(jsQRScriptLoaded) return resolve();
          const script = document.createElement('script');
          script.src = "https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js";
          script.onload = () => {
            jsQRScriptLoaded = true;
            resolve();
          };
          script.onerror = () => reject(new Error("Failed to load jsQR library"));
          document.head.appendChild(script);
        });
      }

      async function scanFrame(){
        if(!scanning) return;
        if(!jsQRScriptLoaded){
          try{
            await loadJsQRScript();
          } catch(e){
            alert(e.message);
            stopScan();
            return;
          }
        }
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "dontInvert",
        });
        if(code){
          scanResult.textContent = "QR Code Content: " + code.data;
          stopScan();
        } else {
          requestAnimationFrame(scanFrame);
        }
      }

      // Bulk CSV upload parsing and generation
      bulkUpload.addEventListener('change', e => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = evt => {
          bulkResults.innerHTML = "";
          const lines = evt.target.result.split(/\r?\n/).filter(l=>l.trim());
          lines.forEach((line, idx) => {
            // Format: dataType,data
            const parts = line.split(",");
            if(parts.length < 2){
              bulkResults.innerHTML += `<p style="color: red;">Line ${idx+1}: Invalid format.</p>`;
              return;
            }
            const bulkType = parts[0].trim();
            const bulkData = parts.slice(1).join(",").trim();
            try {
              const bulkQr = new QRious({
                value: bulkData,
                size: 200,
                level: "M",
              });
              const img = document.createElement('img');
              img.src = bulkQr.toDataURL();
              img.alt = `QR Code for ${bulkData}`;
              img.style.margin = "8px";
              img.title = bulkData;
              bulkResults.appendChild(img);
            } catch(e){
              bulkResults.innerHTML += `<p style="color: red;">Line ${idx+1}: Error generating QR code.</p>`;
            }
          });
        };
        reader.readAsText(file);
      });

      // Initial render history
      renderHistory();

    });
  </script>
</body>
</html>
